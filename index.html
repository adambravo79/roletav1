<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Roleta Profissional Avan√ßada</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
h1 { color: #333; }
#controls { margin: 20px 0; }
input { padding: 5px; font-size: 16px; }
button { padding: 6px 12px; font-size: 16px; margin: 5px; cursor:pointer; }
#roletaContainer { position: relative; width: 400px; height: 400px; margin: 20px auto; }
#roletaCanvas { border-radius: 50%; background: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
#pin { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid red; z-index: 10; }
ul { list-style: none; padding: 0; max-width: 500px; margin: 20px auto; text-align: left; }
li { margin: 5px 0; }
</style>
</head>
<body>

<h1>Roleta Profissional Avan√ßada</h1>

<div id="controls">
  <input type="text" id="novoAssunto" placeholder="Adicionar assunto">
  <button onclick="adicionarAssunto()">Adicionar</button>
  <button onclick="girarRoleta()">Girar üéµ</button>
  <button onclick="resetHistorico()">Resetar Hist√≥rico</button>
  <button onclick="exportarCSV()">Exportar CSV</button>
</div>

<div id="roletaContainer">
  <canvas id="roletaCanvas" width="400" height="400"></canvas>
  <div id="pin"></div>
</div>

<h2 id="resultado"></h2>

<h3>Lista de Assuntos</h3>
<ul id="assuntos"></ul>

<h3>Hist√≥rico</h3>
<ul id="historico"></ul>

<audio id="musica" src="sua-musica.mp3"></audio>
<audio id="click" src="click.mp3"></audio>

<script>
const canvas = document.getElementById('roletaCanvas');
const ctx = canvas.getContext('2d');
const raio = canvas.width/2;
let lista = JSON.parse(localStorage.getItem('lista'))||[];
let historico = JSON.parse(localStorage.getItem('historico'))||[];
let anguloAtual = 0;
let girando = false;

function salvar(){
  localStorage.setItem('lista',JSON.stringify(lista));
  localStorage.setItem('historico',JSON.stringify(historico));
}

function renderizarLista(){
  const ul = document.getElementById('assuntos');
  ul.innerHTML='';
  lista.forEach((item,i)=>{
    const li=document.createElement('li');
    li.textContent = item.nome + (item.comprado?' (Comprado)':'');
    if(!item.comprado){
      const btn=document.createElement('button');
      btn.textContent='Comprar';
      btn.onclick=()=>comprarAssunto(i);
      li.appendChild(btn);
    }
    ul.appendChild(li);
  });

  const histUl=document.getElementById('historico');
  histUl.innerHTML='';
  historico.slice().reverse().forEach(h=>{
    const li=document.createElement('li');
    li.textContent=`${h.data} ‚Üí Sorteado: ${h.sorteado}, Comprados: ${h.comprados.join(', ')}`;
    histUl.appendChild(li);
  });
}

function desenharRoleta(){
  const disponiveis = lista.filter(a=>!a.comprado);
  const n = disponiveis.length;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  disponiveis.forEach((item,i)=>{
    const angInicio = (2*Math.PI/n)*i;
    const angFim = angInicio + 2*Math.PI/n;

    ctx.beginPath();
    ctx.moveTo(raio,raio);
    ctx.arc(raio,raio,raio,angInicio,angFim);
    ctx.fillStyle=`hsl(${i*360/n},70%,70%)`;
    ctx.shadowColor='rgba(0,0,0,0.3)';
    ctx.shadowBlur=10;
    ctx.fill();
    ctx.stroke();

    // Texto centralizado
    ctx.save();
    ctx.translate(raio,raio);
    ctx.rotate(angInicio + Math.PI/n);
    ctx.textAlign="right";
    ctx.fillStyle="#000";
    ctx.font="bold 16px Arial";
    ctx.fillText(item.nome, raio-20,5);
    ctx.restore();
  });
}

function adicionarAssunto(){
  const input=document.getElementById('novoAssunto');
  if(input.value.trim()!==""){
    lista.push({nome:input.value.trim(),comprado:false});
    input.value='';
    salvar();
    renderizarLista();
    desenharRoleta();
  }
}

function comprarAssunto(index){
  lista[index].comprado=true;
  salvar();
  renderizarLista();
  desenharRoleta();
}

function girarRoleta(){
  if(girando) return;
  const disponiveis = lista.filter(a=>!a.comprado);
  if(disponiveis.length===0){alert('Nenhum assunto dispon√≠vel!'); return;}

  girando=true;
  const audio=document.getElementById('musica');
  audio.currentTime=0;
  audio.play();
  const clickAudio=document.getElementById('click');

  const sorteadoIndex = Math.floor(Math.random()*disponiveis.length);
  const n = disponiveis.length;
  const fatiaGraus = 360/n;
  const alvo = 360*6 + sorteadoIndex*fatiaGraus + fatiaGraus/2;
  const duracao = 5500;

  const inicio = performance.now();
  const rotIni = anguloAtual;
  const rotFim = anguloAtual+alvo;

  function anim(t){
    const tempo = t - inicio;
    const perc = Math.min(tempo/duracao,1);
    const ang = rotIni + (rotFim-rotIni)*(1 - Math.pow(1-perc,3));
    canvas.style.transform=`rotate(${ang}deg)`;

    const fatiasPassadas = Math.floor(ang/fatiaGraus);
    if(anim.ultimoClick!==fatiasPassadas){
      clickAudio.currentTime=0;
      clickAudio.play();
      anim.ultimoClick=fatiasPassadas;
    }

    if(perc<1) requestAnimationFrame(anim);
    else{
      anguloAtual=rotFim%360;
      audio.pause();
      const sorteado = disponiveis[sorteadoIndex].nome;
      document.getElementById('resultado').textContent=`Sorteado: ${sorteado}`;
      const comprados=lista.filter(a=>a.comprado).map(a=>a.nome);
      historico.push({data:new Date().toLocaleString(),sorteado,comprados});
      salvar();
      renderizarLista();
      girando=false;
    }
  }
  anim.ultimoClick=-1;
  requestAnimationFrame(anim);
}

function resetHistorico(){
  if(confirm('Deseja realmente resetar o hist√≥rico?')){
    historico=[];
    salvar();
    renderizarLista();
  }
}

function exportarCSV(){
  let csv="Data,Sorteado,Comprados\n";
  historico.forEach(h=>{
    csv+=`"${h.data}","${h.sorteado}","${h.comprados.join(';')}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download="historico_roleta.csv";
  a.click();
  URL.revokeObjectURL(url);
}

renderizarLista();
desenharRoleta();
</script>

</body>
</html>
